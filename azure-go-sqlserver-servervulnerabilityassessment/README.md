# Deploying Azure SQL Server and Database with Server Vulnerability Assessment in GO

Deploys Azure SQL Server & Database with Server Vulnerability Assessment. [Azure Defender for SQL Server](https://docs.microsoft.com/en-us/azure/azure-sql/database/azure-defender-for-sql) turned on at *subscription* level. The Server Vulnerability Assessment is commented out due to Azure Eventual Consistency issues.

## Turning on Azure Defender for SQL Server

1. Via [azure cli](https://docs.microsoft.com/en-us/cli/azure/security/pricing?view=azure-cli-latest#az_security_pricing_create).  Once Azure Defender is enabled the very 1st time, wait 5 minutes to allow it to propagates across the subscription.  We did it this way.
```bash
az security pricing create -n SQLServers --tier 'standard'
```

OR

1. Via [Azure Portal](https://docs.microsoft.com/en-us/azure/azure-sql/database/azure-defender-for-sql?WT.mc_id=Portal-Microsoft_Azure_Security#enable-azure-defender)

## Deployment

1. Login to Azure CLI (you will be prompted to do this during deployment if you forget this step)

    ```bash
    az login
    ```

1. Create a new stack:

    ```bash
    pulumi stack init dev
    ```

1. Configure the location to deploy the resources to.  The Azure region to deploy to is pre-set to **WestUS** - but you can modify the region you would like to deploy to.

    ```bash
    pulumi config set azure-native:location eastus2
    ```
1. Create that stack via `pulumi up`
    ```bash
    pulumi up -y
    ```

    The Result will be

    ```bash
    Updating (dev)

    View Live: https://app.pulumi.com/shaht/azure-go-sqlserver-servervulnerabilityassessment/dev/updates/30

        Type                                     Name                                                  Status      
    +   pulumi:pulumi:Stack                      azure-go-sqlserver-servervulnerabilityassessment-dev  created     
    +   ├─ random:index:RandomPassword           loginpassword                                         created     
    +   ├─ azure-native:resources:ResourceGroup  vulnerability-rg                                      created     
    +   ├─ azure-native:sql:Server               vulnerability-sqlserver                               created     
    +   ├─ azure-native:storage:StorageAccount   vulnstorageacct                                       created     
    +   ├─ azure-native:storage:BlobContainer    vulnerabilityblobcontainer                            created     
    +   └─ azure-native:sql:Database             vulnerability-sqldatabase                             created     
    
    Outputs:
        blob_container_name    : "vulnerabilityblobcontainer"
        primarystoragekey      : "[secret]"
        resourcegroup_name     : "vulnerability-rg9aa03f29"
        sqladmin_password      : "[secret]"
        sqladmin_user          : "pulumiadmin"
        sqlserver_database_name: "vulnerability-sqldatabase"
        sqlserver_name         : "vulnerability-sqlserver7ad52e2b"
        storage_path_container : "https://vulnstorageacct16db2cec.blob.core.windows.net/vulnerabilityblobcontainer"
        storageaccount_name    : "vulnstorageacct16db2cec"

    Resources:
        + 7 created

    Duration: 2m31s
    ```
1. Check the Outputs
   ```bash
   pulumi stack output
   ```
   Returns:
   ```bash
    Current stack outputs (9):
    OUTPUT                   VALUE
    blob_container_name      vulnerabilityblobcontainer
    primarystoragekey        [secret]
    resourcegroup_name       vulnerability-rg9aa03f29
    sqladmin_password        [secret]
    sqladmin_user            pulumiadmin
    sqlserver_database_name  vulnerability-sqldatabase
    sqlserver_name           vulnerability-sqlserver7ad52e2b
    storage_path_container   https://vulnstorageacct16db2cec.blob.core.windows.net/vulnerabilityblobcontainer
    storageaccount_name      vulnstorageacct16db2cec
   ```

1. Wait 3-5 minutes and uncomment the following code blocks.  This is an Azure issue with eventual consistency.
    - Uncomment out block of code for [*serverVulnerabilityAssessment*](https://github.com/tusharshahrs/pulumi-home/blob/main/azure-ts-sqlserver-servervulnerabilityassessment/index.ts#L74-L89).
    - Uncomment out the ouputs for [*server_vulnerability_assessment_name*](https://github.com/tusharshahrs/pulumi-home/blob/main/azure-ts-sqlserver-servervulnerabilityassessment/index.ts#L97) & [*server_vulnerability_assessment_type*](https://github.com/tusharshahrs/pulumi-home/blob/main/azure-ts-sqlserver-servervulnerabilityassessment/index.ts#L98).
    
1. Run *pulumi up* until the *server vulnerability assessment* is created    
   ```bash
   pulumi up -y
   ```
   Results
   ```bash
   Updating (dev)

    View Live: https://app.pulumi.com/shaht/azure-go-sqlserver-servervulnerabilityassessment/dev/updates/35

        Type                                               Name                                                  Status      
        pulumi:pulumi:Stack                                azure-go-sqlserver-servervulnerabilityassessment-dev              
    +   └─ azure-native:sql:ServerVulnerabilityAssessment  servervulnerabilityassessment                         created     
    
    Outputs:
        blob_container_name                 : "vulnerabilityblobcontainer"
        primarystoragekey                   : "[secret]"
        resourcegroup_name                  : "vulnerability-rg9aa03f29"
    + server_vulnerability_assessment_name: "Default"
    + server_vulnerability_assessment_type: "Microsoft.Sql/servers/vulnerabilityAssessments"
        sqladmin_password                   : "[secret]"
        sqladmin_user                       : "pulumiadmin"
        sqlserver_database_name             : "vulnerability-sqldatabase"
        sqlserver_name                      : "vulnerability-sqlserver7ad52e2b"
        storage_path_container              : "https://vulnstorageacct16db2cec.blob.core.windows.net/vulnerabilityblobcontainer"
        storageaccount_name                 : "vulnstorageacct16db2cec"

    Resources:
        + 1 created
        7 unchanged
    ```

1. Check the Outputs again
   ```bash
   pulumi stack output
   ```
   Returns
   ```bash
   Current stack outputs (11):
    OUTPUT                                VALUE
    blob_container_name                   vulnerabilityblobcontainer
    primarystoragekey                     [secret]
    resourcegroup_name                    vulnerability-rg9aa03f29
    server_vulnerability_assessment_name  Default
    server_vulnerability_assessment_type  Microsoft.Sql/servers/vulnerabilityAssessments
    sqladmin_password                     [secret]
    sqladmin_user                         pulumiadmin
    sqlserver_database_name               vulnerability-sqldatabase
    sqlserver_name                        vulnerability-sqlserver7ad52e2b
    storage_path_container                https://vulnstorageacct16db2cec.blob.core.windows.net/vulnerabilityblobcontainer
    storageaccount_name                   vulnstorageacct16db2cec
   ```

1. Destroy the Stack
   ```bash
   pulumi destoy -y
   ```

1. Remove the Stack
   ```bash
   pulumi stack rm dev
   ```