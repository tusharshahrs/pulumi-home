import * as pulumi from "@pulumi/pulumi";
import * as resources from "@pulumi/azure-native/resources";
import * as storage from "@pulumi/azure-native/storage";
import * as sql from "@pulumi/azure-native/sql";
import * as random from "@pulumi/random";

const name = "vulnerability"
// Create an Azure Resource Group
const resourceGroup = new resources.ResourceGroup(`${name}-rg`);

// Create an Azure resource (Storage Account)
const storageAccount = new storage.StorageAccount(`${name}sa`, {
    resourceGroupName: resourceGroup.name,
    sku: {
        name: storage.SkuName.Standard_LRS,
    },
    kind: storage.Kind.StorageV2,
}, {parent: resourceGroup });

// Export the primary key of the Storage Account
const storageAccountKeys = pulumi.all([resourceGroup.name, storageAccount.name]).apply(([resourceGroupName, accountName]) =>
    storage.listStorageAccountKeys({ resourceGroupName, accountName }));
const primaryStorageKey = storageAccountKeys.keys[0].value;

// Create random password for sql admin
const sqlpassword = new random.RandomPassword(`${name}-sqlseverpassword`, {
    length: 16,
    minLower: 4,
    minUpper: 4, 
    number: true,
    minNumeric: 4,
    special: false,
    });

// create sql admin user
const username = "pulumiadmin";

// create an Azure sql server
const sqlServer = new sql.Server(`${name}-sqlserver`, {
    resourceGroupName: resourceGroup.name,
    administratorLogin: username,
    administratorLoginPassword: sqlpassword.result,
    version: "12.0",
}, {parent: resourceGroup });

// Enable log analytics for the sql server (master DB)
// Get the master DB
// Need to sleep a bit for the master DB to be created on the sql server before trying to use it.
// This doesnâ€™t create the DB - it gets the auto-created master DB so that loganalytics can be enabled.
const masterDb = sqlServer.id.apply(async (id) => {
    await new Promise(f => setTimeout(f, 30000))
    const masterDbId = `${id}/databases/master`
    return(sql.Database.get("masterDb", masterDbId))
})

// create an Azure sql server database
const database = new sql.Database(`${name}-database`, {
    resourceGroupName: resourceGroup.name,
    serverName: sqlServer.name,
    sku: {
        name: "S0",
    },
}, {parent: sqlServer, dependsOn: masterDb});

// Create an Azure blob container
const myContainer = new storage.BlobContainer(`${name}-blobcontainer`, {
    resourceGroupName: resourceGroup.name,
    accountName: storageAccount.name,
},{dependsOn: [resourceGroup, storageAccount]});

export const storagecontainerpath = pulumi.interpolate`https://${storageAccount.name}.blob.core.windows.net/${myContainer.name}`;

/*const serverVulnerabilityAssessment = new sql.ServerVulnerabilityAssessment(`${name}-servervulnerabilityassessment`, {
    recurringScans: {
        emailSubscriptionAdmins: true,
        emails: [
            "tushar@pulumi.com"
        ],
        isEnabled: true,
    },
    resourceGroupName: resourceGroup.name,
    serverName: sqlServer.name,
    storageAccountAccessKey: primaryStorageKey,
    storageContainerPath: storagecontainerpath,
    vulnerabilityAssessmentName: "default",
});
*/

export const resourcegroup_name = resourceGroup.name;
export const storageaccount_name = storageAccount.name;
export const sql_user = username;
export const sql_password = sqlpassword.result;
export const sqlserver_name = sqlServer.name;
export const blob_container_name = myContainer.name;
//export const server_vulnerability_assessment_name = serverVulnerabilityAssessment.name;
//export const server_vulnerability_assessment_type = serverVulnerabilityAssessment.type;