# Deploying Azure SQL Server and Database with Server Vulnerability Assessment

Deploys Azure SQL Server and Database with Server Vulnerability Assessment.  [Azure Defender for SQL Server](https://docs.microsoft.com/en-us/azure/azure-sql/database/azure-defender-for-sql) turned on at *subscription* level.  The Server Vulnerability Assessment is commented out because we have to wait a couple of minutes and then uncomment that code and run it again due to Azure Eventual Consistency issues.

## Turning on Azure Defender for SQL Server

1. Via [azure cli](https://docs.microsoft.com/en-us/cli/azure/security/pricing?view=azure-cli-latest#az_security_pricing_create).  Once Azure Defender is enabled the very 1st time, wait 5 minutes to allow it to propagates across the subscription.  We did it this way.
```bash
az security pricing create -n SQLServers --tier 'standard'
```

OR

1. Via [Azure Portal](https://docs.microsoft.com/en-us/azure/azure-sql/database/azure-defender-for-sql?WT.mc_id=Portal-Microsoft_Azure_Security#enable-azure-defender)


## Deployment

1. Login to Azure CLI (you will be prompted to do this during deployment if you forget this step)

    ```bash
    az login
    ```

1. Create a new stack:

    ```bash
    pulumi stack init dev
    ```
1. Install dependencies
    ```bash
    npm install
    ```
1. Configure the location to deploy the resources to.  The Azure region to deploy to is pre-set to **WestUS** - but you can modify the region you would like to deploy to.

    ```bash
    pulumi config set azure-native:location eastus2
    ```
1. Create that stack via `pulumi up`.  We will have to run this back to back until I figure out how to fix the error.
    ```bash
    pulumi up -y
    ```

    The Result will be

    ```bash
    View Live: https://app.pulumi.com/shaht/azure-ts-sqlserver-servervulnerabilityassessment/dev/updates/40

        Type                                               Name                                                  Status                  Info
    +   pulumi:pulumi:Stack                                azure-ts-sqlserver-servervulnerabilityassessment-dev  **creating failed**     1 error
    +   ├─ azure-native:resources:ResourceGroup            vulnerability-rg                                      created                 
    +   │  ├─ azure-native:storage:StorageAccount          vulnerabilitysa                                       created                 
    +   │  └─ azure-native:sql:Server                      vulnerability-sqlserver                               created                 
    +   │     └─ azure-native:sql:Database                 sqldatabase                                           created                 
    +   ├─ random:index:RandomPassword                     vulnerability-sqlseverpassword                        created                 
    +   ├─ azure-native:storage:BlobContainer              vulnerability-blobcontainer                           created                 
    
    Outputs:
        blob_container_name : "vulnerability-blobcontainer"
        resourcegroup_name  : "vulnerability-rg014ac399"
        sql_password        : "[secret]"
        sql_user            : "pulumiadmin"
        sqlserver_name      : "vulnerability-sqlserver7e99c28e"
        storageaccount_name : "vulnerabilitysa10570ab5"
        storagecontainerpath: "https://vulnerabilitysa10570ab5.blob.core.windows.net/vulnerability-blobcontainer"

    Resources:
        + 7 created

    Duration: 2m47s

1. Wait 2-4 minutes and uncomment the following code blocks.  This is an Azure issue with eventual consistency.
    - Uncomment out block of code for [*serverVulnerabilityAssessment*](https://github.com/tusharshahrs/pulumi-home/blob/main/azure-ts-sqlserver-servervulnerabilityassessment/index.ts#L74-L89).  
    - Uncomment out the ouputs for [*server_vulnerability_assessment_name*](https://github.com/tusharshahrs/pulumi-home/blob/main/azure-ts-sqlserver-servervulnerabilityassessment/index.ts#L97) & [*server_vulnerability_assessment_type*](https://github.com/tusharshahrs/pulumi-home/blob/main/azure-ts-sqlserver-servervulnerabilityassessment/index.ts#L98).
    
1. Run *pulumi up* until the *server vulnerability assessment* is created    
   ```bash
   pulumi up -y
   ```

   Results
   ```bash
   Updating (dev)

    View Live: https://app.pulumi.com/shaht/azure-ts-sqlserver-servervulnerabilityassessment/dev/updates/121

        Type                                               Name                                                  Status      
        pulumi:pulumi:Stack                                azure-ts-sqlserver-servervulnerabilityassessment-dev              
    +   └─ azure-native:sql:ServerVulnerabilityAssessment  vulnerability-servervulnerabilityassessment           created     
    
    Outputs:
        blob_container_name : "vulnerability-blobcontainer"
        resourcegroup_name  : "vulnerability-rg5efb011f"
        sql_password        : "[secret]"
        sql_user            : "pulumiadmin"
        sqlserver_name      : "vulnerability-sqlserver3d0dc476"
        storageaccount_name : "vulnerabilitysaf5d73786"
        storagecontainerpath: "https://vulnerabilitysaf5d73786.blob.core.windows.net/vulnerability-blobcontainer"

    Resources:
        + 1 created
        7 unchanged

    Duration: 4s
   ```

1. Check the Outputs
   ```bash
   pulumi stack output
   ```

   Returns:
   ```bash
    Current stack outputs (9):
    OUTPUT                                VALUE
    blob_container_name                   vulnerability-blobcontainer
    resourcegroup_name                    vulnerability-rgcc4e51ef
    server_vulnerability_assessment_name  Default
    server_vulnerability_assessment_type  Microsoft.Sql/servers/vulnerabilityAssessments
    sql_password                          [secret]
    sql_user                              pulumiadmin
    sqlserver_name                        vulnerability-sqlserver9d929848
    storageaccount_name                   vulnerabilitysa264e879b
    storagecontainerpath                  https://vulnerabilitysa264e879b.blob.core.windows.net/vulnerability-blobcontainer
   ```

1. Destroy the Stack
   ```bash
   pulumi destroy -y
   ```

1. Remove the stack
   ```bash
   pulumi stack rm dev
   ```